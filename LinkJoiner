(function() {
    'use strict';

    const config = { 
        bg: '#000', 
        card: '#0a0a0a', 
        blue: '#007bff', 
        darkBlue: '#0056b3', 
        border: '#111', 
        textBlue: '#3498db' 
    };
    
    let seenCodes = new Set();
    let allLinks = []; 
    let joinedCodes = new Set(); 
    let lastRecentIndex = -1; 
    let hiddenUsers = new Set(); 
    let currentFilter = 'recent';
    let isMinimized = false;
    let currentScale = localStorage.getItem('flj_scale') || 1;
    let skipRating = localStorage.getItem('flj_skip_rating') === 'true';

    const old = document.getElementById("flj-v-final");
    if (old) old.remove();

    const ui = document.createElement("div");
    ui.id = "flj-v-final";
    ui.style.cssText = `position: fixed; top: 20px; right: 20px; width: 280px; height: 500px; background: ${config.bg}; border: 1px solid ${config.border}; z-index: 1000000; font-family: sans-serif; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 0 20px #000; color: white; transform: scale(${currentScale}); transform-origin: top right; transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1); overflow: hidden;`;
    
    ui.innerHTML = `
        <style>
            @keyframes slideIn {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            .link-card { animation: slideIn 0.3s ease-out; }
            
            .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
            .switch input { opacity: 0; width: 0; height: 0; }
            .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #222; transition: .4s; border-radius: 34px; }
            .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
            input:checked + .slider { background-color: ${config.blue}; }
            input:checked + .slider:before { transform: translateX(16px); }
            
            #flj-list::-webkit-scrollbar { width: 4px; }
            #flj-list::-webkit-scrollbar-thumb { background: ${config.blue}; border-radius: 10px; }
            
            .btn-click-effect:active { transform: scale(0.95); opacity: 0.8; }
            .blue-glow:hover { box-shadow: 0 0 10px ${config.blue}; }
            
            #toggle-sorts-btn {
                background: none; border: none; color: #333; cursor: pointer;
                font-size: 8px; padding: 2px; width: 100%; display: flex;
                justify-content: center; align-items: center; transition: 0.2s;
                border-bottom: 1px solid #111;
            }
            #toggle-sorts-btn:hover { color: ${config.blue}; background: #050505; }
        </style>
        <div id="flj-header" style="display: flex; flex-direction: column; border-bottom: 1px solid #111; flex-shrink: 0;">
            <div id="flj-drag" style="padding: 10px 12px 5px 12px; cursor: move; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; font-size: 13px; user-select:none; letter-spacing: 0.5px; color:${config.blue};">‚ö° Link Joiner</span>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="flj-minimize" style="background:none; border:none; color:#444; cursor:pointer; font-size:12px;">‚ñ≤</button>
                    <button id="flj-close" style="background:none; border:none; color:#fff; cursor:pointer; font-size:16px;">‚úï</button>
                </div>
            </div>
            <div id="flj-action-bar" style="padding: 5px 12px 10px 12px; display: flex; gap: 6px; align-items: center;">
                <button id="flj-settings-btn" class="btn-click-effect blue-glow" style="background:#111; border:1px solid #222; color:#fff; cursor:pointer; width:28px; height:28px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px;">‚öôÔ∏è</button>
                <button id="flj-refresh-btn" class="btn-click-effect blue-glow" style="background:#111; border:1px solid #222; color:#fff; cursor:pointer; width:28px; height:28px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px;">üîÑ</button>
                <div style="flex:1; display:flex; gap:4px;">
                    <button id="join-recent" class="btn-click-effect" style="flex:1; background:${config.blue}; color:#fff; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:10px; font-weight:bold;">RECENT</button>
                    <button id="join-random" class="btn-click-effect" style="flex:1; background:#000; color:${config.blue}; border:1px solid ${config.blue}; padding:6px; border-radius:4px; cursor:pointer; font-size:10px; font-weight:bold;">RANDOM</button>
                </div>
            </div>
            <div id="flj-settings-panel" style="display:none; background:#050505; padding:12px; border-top:1px solid #111; font-size:10px; flex-direction: column; gap: 12px;">
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <div style="display:flex; justify-content:space-between; color:#666;">
                        <span>UI SCALE</span>
                        <span id="scale-val" style="color:${config.blue}">${Math.round(currentScale * 100)}%</span>
                    </div>
                    <input type="range" id="ui-scale-slider" min="0.5" max="1.5" step="0.05" value="${currentScale}" style="width:100%; cursor:pointer; accent-color:${config.blue};">
                </div>
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <span style="color:#eee; font-weight:bold;">SKIP RATING</span>
                    <label class="switch">
                        <input type="checkbox" id="skip-rating-toggle" ${skipRating ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div id="flj-main-content" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <div id="flj-sorts-container">
                <div id="flj-filter-bar" style="padding: 6px; background: #050505; border-bottom: 1px solid #111; display: flex; gap: 4px; justify-content: center; flex-shrink: 0;">
                    <button class="sort-btn active" data-sort="recent" style="background:${config.blue}; color:#fff; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:9px; font-weight:bold;">Recent</button>
                    <button class="sort-btn" data-sort="stacked" style="background:#000; color:${config.blue}; border:1px solid ${config.blue}; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:9px; font-weight:bold;">Stacked</button>
                    <button class="sort-btn" data-sort="mid" style="background:#000; color:${config.blue}; border:1px solid ${config.blue}; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:9px; font-weight:bold; opacity:0.7;">Mid</button>
                    <button class="sort-btn" data-sort="shit" style="background:#000; color:${config.blue}; border:1px solid ${config.blue}; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:9px; font-weight:bold; opacity:0.4;">Shit</button>
                </div>
            </div>
            <button id="toggle-sorts-btn">‚ñº</button>
            <div id="flj-list" style="padding: 8px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; background: #000;">
                <div id="flj-empty" style="color: #222; text-align: center; margin-top: 140px; font-size: 10px; letter-spacing:1px;">SCANNING...</div>
            </div>
        </div>
    `;
    document.body.appendChild(ui);

    let sortsVisible = true;
    document.getElementById("toggle-sorts-btn").onclick = () => {
        sortsVisible = !sortsVisible;
        document.getElementById("flj-sorts-container").style.display = sortsVisible ? "block" : "none";
        document.getElementById("toggle-sorts-btn").innerText = sortsVisible ? "‚ñº" : "‚ñ≤";
    };

    function formatTime(ms) {
        const s = Math.floor(ms / 1000);
        const m = Math.floor(s / 60);
        if (m > 0) return `${m}m ago`;
        return `${s}s ago`;
    }

    const list = document.getElementById("flj-list");

    document.getElementById("join-recent").onclick = () => {
        if (allLinks.length === 0) return;
        lastRecentIndex++;
        if (lastRecentIndex >= allLinks.length) lastRecentIndex = 0;
        const target = allLinks[lastRecentIndex];
        window.open(target.url, '_blank');
        const cardBtn = document.querySelector(`[data-code="${target.code}"] .j-btn`);
        if (cardBtn) cardBtn.click();
    };

    document.getElementById("join-random").onclick = () => {
        let unjoined = allLinks.filter(l => !joinedCodes.has(l.code));
        if (unjoined.length === 0 && allLinks.length > 0) {
            joinedCodes.clear();
            unjoined = allLinks;
        }
        if (unjoined.length > 0) {
            const random = unjoined[Math.floor(Math.random() * unjoined.length)];
            joinedCodes.add(random.code);
            window.open(random.url, '_blank');
            const cardBtn = document.querySelector(`[data-code="${random.code}"] .j-btn`);
            if (cardBtn) cardBtn.click();
        }
    };

    document.getElementById("ui-scale-slider").oninput = (e) => {
        let val = e.target.value;
        ui.style.transform = `scale(${val})`;
        document.getElementById("scale-val").innerText = `${Math.round(val * 100)}%`;
        localStorage.setItem('flj_scale', val);
    };

    document.getElementById("skip-rating-toggle").onchange = (e) => {
        skipRating = e.target.checked;
        localStorage.setItem('flj_skip_rating', skipRating);
    };

    document.getElementById("flj-settings-btn").onclick = () => {
        const p = document.getElementById("flj-settings-panel");
        p.style.display = p.style.display === "none" ? "flex" : "none";
    };

    document.getElementById("flj-minimize").onclick = () => {
        isMinimized = !isMinimized;
        ui.style.height = isMinimized ? "40px" : "500px";
        document.getElementById("flj-minimize").innerText = isMinimized ? "‚ñº" : "‚ñ≤";
    };

    function applyFilter() {
        document.querySelectorAll('.link-card').forEach(card => {
            if (currentFilter === 'recent') card.style.display = 'block';
            else card.style.display = card.dataset.rating === currentFilter ? 'block' : 'none';
        });
    }

    ui.querySelectorAll('.sort-btn').forEach(btn => {
        btn.onclick = () => {
            ui.querySelectorAll('.sort-btn').forEach(b => { 
                b.style.background = "#000"; 
                b.style.color = config.blue;
            });
            btn.style.background = config.blue;
            btn.style.color = "#fff";
            currentFilter = btn.dataset.sort;
            applyFilter();
        };
    });

    function createCard(code, name, url) {
        if (seenCodes.has(code) || hiddenUsers.has(name)) return;
        seenCodes.add(code);
        allLinks.unshift({code, url});
        lastRecentIndex = -1;

        let startTime = Date.now();
        let status = "Posted";
        
        const card = document.createElement("div");
        card.className = "link-card";
        card.dataset.rating = "none";
        card.dataset.code = code;
        card.style.cssText = `background: ${config.card}; border: 1px solid #111; padding: 12px; border-radius: 8px; border-left: 3px solid #222; margin-bottom: 4px; flex-shrink: 0; transition: 0.3s;`;
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <span style="font-size: 11px; font-weight: bold; color: #ccc;">üë§ ${name}</span>
                    <span class="post-time" style="font-size: 8px; color: ${config.blue};">Posted 0s ago</span>
                </div>
                <button class="hide-btn" style="background:none; border:none; color:#333; cursor:pointer; font-size:9px;">HIDE</button>
            </div>
            <div class="card-actions">
                <button class="j-btn btn-click-effect" style="width: 100%; background: ${config.blue}; color: #fff; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; box-shadow: 0 4px 10px rgba(0,123,255,0.2);">JOIN</button>
            </div>
            <div class="rating-box" style="display: none; flex-direction: column; gap: 6px;">
                <button class="rate-btn btn-click-effect" data-val="stacked" style="background:${config.blue}; color:#fff; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:12px;">STACKED</button>
                <button class="rate-btn btn-click-effect" data-val="mid" style="background:#111; color:${config.blue}; border:1px solid ${config.blue}; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:12px;">MID</button>
                <button class="rate-btn btn-click-effect" data-val="shit" style="background:#000; color:#444; border:1px solid #222; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:12px;">SHIT</button>
            </div>
        `;

        const timeEl = card.querySelector('.post-time');
        const timer = setInterval(() => {
            timeEl.innerText = `${status} ${formatTime(Date.now() - startTime)}`;
        }, 1000);

        const jBtn = card.querySelector('.j-btn');
        const ratingBox = card.querySelector('.rating-box');
        const actions = card.querySelector('.card-actions');

        jBtn.onclick = () => {
            if (status !== "Joined") {
                window.open(url, '_blank');
                joinedCodes.add(code);
                status = "Joined";
                startTime = Date.now();
                timeEl.style.color = config.blue;
                timeEl.innerText = "Joined 0s ago";
                if (skipRating) {
                    actions.innerHTML = `<button class="rj-btn btn-click-effect" style="width:100%; background:#111; color:#fff; border:1px solid ${config.blue}; padding:8px; border-radius:6px; cursor:pointer; font-size:10px; font-weight:bold;">REJOIN</button>`;
                    actions.querySelector('.rj-btn').onclick = () => window.open(url, '_blank');
                } else {
                    actions.style.display = "none";
                    ratingBox.style.display = "flex";
                }
            }
        };

        card.querySelectorAll('.rate-btn').forEach(btn => {
            btn.onclick = () => {
                const val = btn.dataset.val;
                card.dataset.rating = val;
                ratingBox.style.display = "none";
                card.style.borderLeftColor = config.blue;
                actions.innerHTML = `<button class="rj-btn btn-click-effect" style="width:100%; background:#050505; color:${config.blue}; border:1px solid ${config.blue}; padding:8px; border-radius:6px; cursor:pointer; font-size:10px; font-weight:bold;">REJOIN (${val.toUpperCase()})</button>`;
                actions.querySelector('.rj-btn').onclick = () => window.open(url, '_blank');
                actions.style.display = "block";
                applyFilter();
            };
        });

        card.querySelector('.hide-btn').onclick = () => { card.remove(); };
        
        const emptyMsg = document.getElementById("flj-empty");
        if (emptyMsg) emptyMsg.remove();
        list.prepend(card);
        applyFilter();
    }

    const scan = setInterval(() => {
        const regex = /(?:code=|privateServerLinkCode=)([a-zA-Z0-9_-]+)/g;
        const textNodes = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while (node = textNodes.nextNode()) {
            let m;
            while ((m = regex.exec(node.nodeValue)) !== null) {
                const code = m[1];
                if (!seenCodes.has(code)) {
                    let author = "User";
                    let parent = node.parentElement;
                    while(parent && parent !== document.body) {
                        const nameEl = parent.querySelector("[class*='name'], [class*='user'], .username, b, strong");
                        if(nameEl) { author = nameEl.innerText.split('\n')[0].trim(); break; }
                        parent = parent.parentElement;
                    }
                    const isPrivate = node.nodeValue.includes('privateServerLinkCode=');
                    const url = isPrivate ? `https://www.roblox.com/games/refer?privateServerLinkCode=${code}` : `https://www.roblox.com/share?code=${code}&type=Server`;
                    createCard(code, author, url);
                }
            }
        }
    }, 1000);

    document.getElementById("flj-close").onclick = () => { clearInterval(scan); ui.remove(); };
    document.getElementById("flj-refresh-btn").onclick = () => { list.innerHTML = ''; seenCodes.clear(); allLinks = []; joinedCodes.clear(); };
    
    let d = false, ox, oy;
    document.getElementById("flj-drag").onmousedown = (e) => { if(e.target.tagName === "BUTTON" || e.target.tagName === "INPUT") return; d = true; ox = (window.innerWidth - ui.offsetLeft - ui.offsetWidth) + e.clientX; oy = ui.offsetTop - e.clientY; };
    document.onmousemove = (e) => { if(d) { ui.style.right = (ox - e.clientX) + 'px'; ui.style.top = (e.clientY + oy) + 'px'; ui.style.left = 'auto'; } };
    document.onmouseup = () => d = false;
})();
