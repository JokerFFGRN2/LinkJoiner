(function() {
    'use strict';

    const config = {
        bg: '#000000',
        card: '#111111',
        green: '#2ed573',
        red: '#ff4757',
        text: '#ffffff'
    };

    const seenCodes = new Set();

    const oldUI = document.getElementById("flj-final-v8");
    if (oldUI) oldUI.remove();

    const ui = document.createElement("div");
    ui.id = "flj-final-v8";
    ui.style.cssText = `
        position: fixed !important; top: 20px !important; right: 20px !important;
        width: 310px !important; height: 430px !important;
        background: ${config.bg} !important; border: 1px solid #111 !important;
        z-index: 1000000 !important; font-family: sans-serif !important;
        border-radius: 12px !important; display: flex !important; flex-direction: column !important;
        box-shadow: 0 0 30px rgba(0,0,0,1) !important; overflow: hidden !important;
    `;
    
    ui.innerHTML = `
        <div id="flj-drag" style="background: #000 !important; color: #fff !important; padding: 12px 15px !important; font-weight: bold !important; cursor: move !important; display: flex !important; justify-content: space-between !important; align-items: center !important; border-bottom: 1px solid #222 !important;">
            <span style="font-size: 14px !important;">âš¡ Link Joiner</span>
            <button id="flj-close" style="border:none !important; background:none !important; cursor:pointer !important; font-size: 20px !important; color: #fff !important;">âœ•</button>
        </div>
        <div id="flj-list" style="padding: 10px !important; overflow-y: auto !important; flex: 1 !important; background: ${config.bg} !important;">
            <div id="flj-empty" style="color: #444 !important; text-align: center !important; margin-top: 160px !important; font-size: 11px !important;">Waiting for links...</div>
        </div>
    `;
    document.body.appendChild(ui);

    function createCard(code, name, url) {
        if (document.getElementById(`c-${code}`)) return null;

        const card = document.createElement("div");
        card.id = `c-${code}`;
        card.style.cssText = `
            background: ${config.card} !important; border: 1px solid #1a1a1a !important;
            padding: 12px !important; border-radius: 10px !important;
            margin-bottom: 10px !important; border-left: 4px solid ${config.green} !important;
        `;
        
        card.innerHTML = `
            <div style="display: flex !important; justify-content: space-between !important; align-items: center !important; margin-bottom: 10px !important;">
                <span style="font-size: 13px !important; font-weight: bold !important; color: ${config.text} !important; max-width: 170px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ðŸ‘¤ ${name}</span>
                <span class="badge-new" style="font-size: 9px !important; color: ${config.green} !important; font-weight: bold !important;">NEW</span>
            </div>
            <button class="j-btn" style="width: 100% !important; background: ${config.green} !important; color: #000 !important; border: none !important; padding: 10px !important; border-radius: 6px !important; cursor: pointer !important; font-weight: bold !important; font-size: 12px !important;">JOIN SERVER</button>
            <div class="timer" style="display:none; text-align:center; font-size: 11px; color: #666; margin-top: 8px;">Recently Joined: <span class="sec">0</span>s ago</div>
        `;

        const btn = card.querySelector('.j-btn');
        const badge = card.querySelector('.badge-new');

        btn.onclick = () => {
            window.open(url, '_blank');
            card.style.setProperty('border-left-color', config.red, 'important');
            btn.style.setProperty('background', config.red, 'important');
            btn.style.setProperty('color', '#fff', 'important');
            btn.innerText = "JOINED";
            btn.disabled = true;
            if (badge) badge.style.display = "none"; 
            const tDiv = card.querySelector('.timer');
            const sSpan = card.querySelector('.sec');
            tDiv.style.display = "block";
            let s = 0;
            setInterval(() => { s++; sSpan.innerText = s; }, 1000);
        };

        return card;
    }

    const scan = setInterval(() => {
        const regex = /(?:code=|privateServerLinkCode=)([a-zA-Z0-9_-]+)/g;
        const html = document.body.innerHTML;
        let m;
        
        while ((m = regex.exec(html)) !== null) {
            const code = m[1];
            if (!seenCodes.has(code)) {
                seenCodes.add(code);
                
                const isPrivate = html.includes('privateServerLinkCode=' + code);
                // Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© &type=Server Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                const url = isPrivate 
                    ? `https://www.roblox.com/games/refer?privateServerLinkCode=${code}` 
                    : `https://www.roblox.com/share?code=${code}&type=Server`;

                let author = "User";
                document.querySelectorAll(".forum-post-container, [class*='post'], .comment, .text-label").forEach(el => {
                    if (el.innerText.includes(code)) {
                        author = el.querySelector("[class*='name'], b, strong, .author")?.innerText.trim() || author;
                    }
                });

                const list = document.getElementById("flj-list");
                const newCard = createCard(code, author, url);
                if (newCard) {
                    document.getElementById("flj-empty")?.remove();
                    list.prepend(newCard);
                }
            }
        }
    }, 1000);

    document.getElementById("flj-close").onclick = () => { clearInterval(scan); ui.remove(); };
    let drag = false, ox, oy;
    document.getElementById("flj-drag").onmousedown = (e) => { drag = true; ox = (window.innerWidth - ui.offsetLeft - ui.offsetWidth) + e.clientX; oy = ui.offsetTop - e.clientY; };
    document.onmousemove = (e) => { if(drag) { ui.style.right = (ox - e.clientX) + 'px'; ui.style.top = (e.clientY + oy) + 'px'; ui.style.left = 'auto'; } };
    document.onmouseup = () => drag = false;

})();
